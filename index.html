<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Calendar & Clock</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos personalizados para refinar la apariencia */
        body {
            font-family: 'Arial Narrow', Arial, sans-serif;
            background-color: #191919; /* Color de fondo de toda la página */
        }
        /* Color personalizado para todo el texto */
        .text-custom-green {
            color: #8ACE00;
        }
        /* Color de fondo personalizado para el cuadro de contenido */
        .bg-custom-dark {
            background-color: #191919; /* Coincide con el fondo del cuerpo */
        }
        /* Estilos para el botón de carga */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #8ACE00; /* Green */
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 2s linear infinite;
            margin-left: 8px; /* Espacio a la izquierda del texto */
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen text-gray-100 p-4">
    <div class="bg-custom-dark p-6 rounded-xl shadow-lg w-full max-w-xs flex flex-col items-start space-y-3">
        <!-- Saludo -->
        <div id="greeting" class="text-3xl md:text-4xl font-bold text-custom-green">
            <!-- Buenos días/tardes/noches -->
        </div>

        <!-- Mostrar Fecha -->
        <div id="date-display" class="text-base md:text-lg font-medium text-custom-green">
            <!-- Viernes, 25 de julio de 2025 -->
        </div>

        <!-- Mostrar Hora -->
        <div id="time-display" class="text-lg md:text-xl font-semibold text-custom-green">
            <!-- 10:11:01 AM -->
        </div>

        <!-- Botón y display de la característica Gemini -->
        <button id="gemini-fact-button" class="mt-4 px-3 py-1.5 bg-custom-dark text-custom-green font-bold rounded-lg shadow-md border border-solid border-custom-green hover:bg-[#2a2a2a] transition duration-300 ease-in-out flex items-center justify-center text-sm">
            ✨ Daily Fact
        </button>
        <div id="gemini-fact-display" class="mt-2 text-xs text-gray-300 italic min-h-[20px]">
            <!-- El dato curioso se mostrará aquí -->
        </div>
    </div>

    <script>
        // Función para actualizar el reloj y la fecha
        function updateClock() {
            const now = new Date(); // Obtener la fecha y hora actuales

            // --- Actualizar Saludo ---
            const hours = now.getHours();
            let greetingText = '';
            if (hours >= 5 && hours < 12) {
                greetingText = 'Good Morning';
            } else if (hours >= 12 && hours < 18) {
                greetingText = 'Good Afternoon';
            } else {
                greetingText = 'Good Evening';
            }
            document.getElementById('greeting').textContent = greetingText;

            // --- Actualizar Fecha ---
            const optionsDate = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const dateString = now.toLocaleDateString('en-US', optionsDate);
            document.getElementById('date-display').textContent = dateString;

            // --- Actualizar Hora ---
            const optionsTime = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true };
            const timeString = now.toLocaleTimeString('en-US', optionsTime);
            document.getElementById('time-display').textContent = timeString;
        }

        // Llamada inicial para establecer el reloj inmediatamente
        updateClock();

        // Actualizar el reloj cada segundo (1000 milisegundos)
        setInterval(updateClock, 1000);

        // --- Integración de la API de Gemini ---
        const geminiFactButton = document.getElementById('gemini-fact-button');
        const geminiFactDisplay = document.getElementById('gemini-fact-display');

        // Función para realizar la llamada a la API de Gemini con reintentos
        async function callGeminiApiWithRetry(prompt, retries = 3, delay = 1000) {
            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };
            const apiKey = ""; // La clave API será proporcionada por el entorno de Canvas.
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        // Si la respuesta no es OK, y no es el último intento, reintenta
                        if (i < retries - 1) {
                            console.warn(`Intento ${i + 1} fallido. Reintentando en ${delay / 1000}s...`);
                            await new Promise(res => setTimeout(res, delay));
                            delay *= 2; // Duplicar el retraso para el próximo intento
                            continue;
                        } else {
                            throw new Error(`Error HTTP: ${response.status} ${response.statusText}`);
                        }
                    }

                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        throw new Error("Estructura de respuesta inesperada de la API de Gemini.");
                    }
                } catch (error) {
                    if (i < retries - 1) {
                        console.error(`Error en el intento ${i + 1}:`, error);
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2;
                    } else {
                        throw error;
                    }
                }
            }
            throw new Error("Todos los reintentos fallaron para la llamada a la API de Gemini.");
        }

        // Manejador de eventos para el botón del dato curioso
        geminiFactButton.addEventListener('click', async () => {
            geminiFactDisplay.textContent = ''; // Limpiar el texto anterior
            geminiFactButton.disabled = true; // Deshabilitar el botón durante la carga
            const originalButtonContent = geminiFactButton.innerHTML; // Guardar el contenido original
            geminiFactButton.innerHTML = '<div class="loader"></div> Loading...'; // Mostrar cargador en inglés

            try {
                const currentDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                const prompt = `Give me an interesting and concise fact about the current date, focusing on historical events, famous birthdays, or scientific discoveries for ${currentDate}. Keep it to one sentence.`;
                const fact = await callGeminiApiWithRetry(prompt);
                geminiFactDisplay.textContent = fact;
            } catch (error) {
                console.error("Error al obtener el dato curioso:", error);
                geminiFactDisplay.textContent = "Sorry, I couldn't get a daily fact right now. Please try again."; // Mensaje de error en inglés
            } finally {
                geminiFactButton.disabled = false; // Habilitar el botón de nuevo
                geminiFactButton.innerHTML = originalButtonContent; // Restaurar el contenido original
            }
        });
    </script>
</body>
</html>
